= Trunk Workflow For Remote Repositories
:description: A guide on the trunk workflow for projects.
:keywords: trunk,workflow,doc-as-code, TODO

include::compendium:partial$_attributes.adoc[]

{role-gtm}
{role-project-lead}
{role-wg-member}
{role-wg-lead}
{role-technical-writer}
{role-service-provider}


IMPORTANT: Never work on the master branch, always create your own <<Create development branch,development branch>>!


== The Trunk
This branch can only be merged to by the ASAM office or the project's Change Control Board (CCB).
Unless indicated by a clear git tag, all commits are considered to be part of a release candidate.

Users **MAY** branch off the trunk for more focused development work.
These branches **SHOULD** be short-lived (<2 weeks) and regularly merged back.
These branches **MAY** be squashed and **MUST** be merged via fast-forward merge (enabled by default).

== Workflow Overview

.Workflow Stages
[mermaid]
....
graph LR
ISSUE
--> INITIAL SETUP
--> ANALYSIS
--> BRANCH CREATION
--> IMPLEMENTATION
--> REVIEW
--> INTEGRATION
--> MERGE;
....

=== Initial setup

*Who: WG Leads*

. Create issues that map to the features in the project list
. Assign the issues to the correct milestone: ``/milestone <milestone>``
. Assign the issues to a responsible: ``/assign @<user>``

=== Analysis

*Who: Issue Assignee*

. Coordinate & drive the preparation of a proposal for addressing the issue.
Either via comments or in further meetings.
. ``/label ~Analysis`` to indicate this issue is being looked at and discussed.

=== Implementation

*Who: Issue Assignee*

. Once a proposal is ready to be implemented, begin submitting work via commits to the develop branch
. [OPTIONAL] An assignee MAY create a separate branch off of _develop_ to make it easier to keep development separate.
Such a branch SHOULD be short-lived (no more than 2 weeks) to ensure progress and direction are visible to project members and that it is not too out of sync with other activities.
. Change the issue status ``/label ~Implementation`` to indicate that a proposal is being implemented for this issue


=== Review

*Who: WG Lead*

. Review implementation progress of issue in WG meetings
. Once the group agrees that the feature is complete:
.. [PREREQUISITE] If a feature branch was created, it MUST have been merged to develop
.. Change the issue status ``/label ~ProjectReview``
.. Create a new branch from develop
.. Remove the encapsulating draft feature flag from the content (make sure that all other content remains within the draft flag) and commit the change.
.. Open a MR to develop, add a comment to request review by the whole project and the implementers forum: ``/request_review @all``.
The MR MUST include document subsection number(s) being reviewed and a link to the lines of source code to be reviewed.

*Who: All project members & Implementers Forum*

. Submit feedback on the changes directly in the MR
* General Feedback: Submit a comment on the MR
* Content specific: Start a review in the changes tab of the MR

+
NOTE: To start a review, write a comment on a diff as normal under the Changes tab in a merge request, and then select Start a review.
Click https://docs.gitlab.com/ee/user/discussions/#starting-a-review[here^] for more information.

* If the review feedback requires further development work, the process restarts from the <<IMPLEMENTATION>> stage

.A demo of a review
image::ReviewExample.gif[]

*Who: CCB*

. If there are no unresolved comments or threads after two weeks the CCB ends the review.
. The MR is assigned to the service provider for integration
.. ``/assign @amuetsch``

=== Integration

. The service provider (SP) refines the content in the MR:
.. Change status to ``/label ~Integration``
* The content is adjusted to adhere to ASAM style and writing conventions
* General editorial rewrites to ensure homogeneity of content


+
IMPORTANT: Questions on content should be addressed to the original issue assignee who will be responsible for ensuring a satisfactory resolution.
In the case that questions lead to significant changes to the content, the MR is reopened for review on resolution.

* On completion of the integration:
.. Create a 2nd MR from the review branch to release (same MR title)
.. Add ``/label ~CCBReview`` to both MRs
.. Both MRs MUST be set to squash commits with fast-forward merging (default).
.. Squash commit message MUST adhere to the commit conventions

=== Merge

*Who: CCB*

. CCB performs a final review of the integrated content
* Is the original content still correctly represented?
* Are all guidelines & conventions maintained?
* Are all discussions resolved?
. CCB merges the MRs to ``develop`` and ``release``

== Create Development Branch
{mandatory}

Each topic must be developed in a separate development branch before it is merged to main when ready.
Please keep in mind to change only few files at once in one branch to minimize the chance for xref:compendium:tools/git/merge_conflicts.adoc[merge conflicts] to occur.

TIP: Give the branch a significant name that describes its intensions.
See xref:compendium:tools/gitlab/branch_naming_conventions.adoc[] for branch name conventions at ASAM.

If you want to switch the branch you are viewing and working on, see xref:compendium:guides/how-to__switch_branches.adoc[].


=== Create Branch From Issue

{recommended}

The recommended way of working is by using issues.

include::compendium:partial$tools/gitlab/create_branch_from_issue.adoc[]

=== Create Development Branch Manually

{optional}

Alternatively, you can create your branch manually, either through GitLab or locally (if set up).

include::compendium:partial$tools/gitlab/branching_repo.adoc[leveloffset=+2]

== Work In Development Branch

{mandatory}

TIP: If you are using the xref:compendium:tools/gitlab/gitlab-ide_guide.adoc[Gitlab IDE], you can edit the files directly in your browser.

If you are using a local setup, you can pull, change, stage, commit and push through Git.
See the guide on xref:compendium:guides/git_interactions.adoc[] for further information on how to work with a repository.

== Commits Conventions
The Commit Message Convention can be found xref:compendium:tools/gitlab/commit_guidelines.adoc[here].

== Mark Content As Draft
If a file contains content that is merged although not completely ready yet, use the feature flag 'draft' to mark the section or instructions in draft mode. +
This allows us to have both a draft document and a reviewed document from the same source through just adding or removing the ``draft`` attribute in the build pipeline.

To convert content to reviewed (i.e. non draft) content, the encapsulating ifdef statement simply needs to be removed (everything that is not in the square brackets).

These flags SHOULD only be modified by WG Leads, the CCB or the ASAM office.

.Using 'draft' to exclude the line "(I think...)" from the following passage
[source]
====
You shall not pass!
ifdef::draft[]
(I think...)
endif::[]
====

// TODO: Add this to a new page and link here:
// You may experience an empty preview in your editor when editing files that contain the mechanism.
// This is actually a good sign.
// The preview is working correctly and hides all parts marked as draft.

// To make the parts visible again, you have to set the attribute `draft` for your preview window.

// **Solution for VisualStudioCode with Asciidoc extension:**

// 1. In the Asciidoc extension settings, go to `Preview:Attributes - Edit in settings.json`.
// 2. In the settings.json, add the `draft` attribute:

//         "asciidoc.preview.attributes": {
//             "draft": ""
//         }

// 3. Save settings.json

// **Solution for AsciidocFX preview:**

// 1. Go to `Settings` on the right hand side of the preview
// 2. Go to the `Preview settings` tab
// 3. Add an `Asciidoctor Attribute` by double-clicking an empty attribute line
// 4. Add attribute `draft` with value `true`
// 5. Save the settings (small button on the lower left of the tab!)
// 6. Reload the preview

// **Solution for GitLab preview:**

// The preview in GitLab intentionally shows the release version of the files, meaning that the parts marked as draft are hidden.

// You can easily switch off the preview and view the source content by clicking on the `display source`-icon on top of the file window:

// image::source_view.png[]

// The icon next to it switches back to the preview.


== Create Merge Request

{mandatory}

After you are done with your work, create a "merge request" (or "pull request"). +
You should always merge back into the branch you branched from: if you branched from the `main` branch, you merge back to it.
If you branched from another feature branch, you merge back to that feature branch.

This is described in xref:compendium:tools/git/merge.adoc[].

It is recommended to only merge a development branch once all issues related to it are closed.
Each merge request must be reviewed internally with a simple review before it is allowed to be merged into `main` in order to minimize mistakes slipping through.

Once a branch is merged into `main`, its changes are now offical and applied.


== General Tips
* ``Code snippets`` are https://code.asam.net/help/user/project/quick_actions[GitLab quick actions^] that can be used directly in comments.
